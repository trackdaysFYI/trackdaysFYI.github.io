<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="One stop to find trackdays near you">
  <title>Trackdays.fyi - Find Trackdays Near You</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" type="text/css" rel="stylesheet" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" type="text/javascript" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
  <script>dayjs.extend(window.dayjs_plugin_relativeTime)</script>
  <script>dayjs.extend(window.dayjs_plugin_utc)</script>
  <script>dayjs.extend(window.dayjs_plugin_customParseFormat)</script>
  <script src="js/caleandar.min.js" type="text/javascript"></script>
  <script src="js/multiselect-dropdown.min.js" type="text/javascript"></script>

  <style>
    * {
      box-sizing: border-box;
        -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* Explorer, Edge */
                user-select: none; /* Chrome, Edge, Opera, Firefox */
     }
    .allowSelect {
        -webkit-user-select: text;
            -ms-user-select: text;
                user-select: text;
    }
    :root {font-family: "Noto Sans", sans-serif; line-height: 1.2; color:rgb(255, 255, 255); background-color: rgb(34,38,42);}
    body {margin: 0;}  /* no remove top/bottom page margin */
    hr {margin: 1rem 0; border: 0; border-top: 1px solid; opacity:0.25;}  /* divider */
    h1, h5 {margin-top: 0; margin-bottom: 0; font-weight: 500;}
    h1 {font-size: 2.4rem;}
    h5 {font-size: 1.2rem;}
    b {font-weight: bolder;}  /* lighter bold */
    svg {vertical-align: middle;}

    .container {max-width: 67em; padding: 1rem;}
    .lead {font-size: 1.1rem; font-weight: 300;}
    .center {margin-left: auto; margin-right: auto; text-align: center;}
    .gray {color: rgb(176, 176, 176)}

    #map {position: relative; width: 100%; height: 55vh; border: 3px solid rgb(100, 100, 100);}
    .popup table, .popup th, .popup td {font-size: 12.5px; border: 1px solid rgb(176, 176, 176); border-collapse: collapse; white-space: nowrap; margin: auto; padding: 2px;}
    .leaflet-container {font-family: unset}
    .leaflet-popup-content-wrapper, .leaflet-popup-tip {background: rgb(240, 240, 240);}
    .leaflet-popup-content {text-align: center; padding-right: 5px; margin: 8px 5px 8px 5px;}
    .dragMe .leaflet-popup-content-wrapper {border-radius: 3px; background: rgba(255, 0, 0, 0.7); color: white; font-size: 0.5rem;}
    .dragMe .leaflet-popup-content {padding-right: 0px; margin: 0px 0px 0px 0px;}
    .dragMe .leaflet-popup-tip {width: 0px; height: 0px;}

    .cld-day::-webkit-scrollbar-thumb, .leaflet-popup-scrolled::-webkit-scrollbar-thumb {background-color: rgb(176, 176, 176);}  /* slider color */
    .cld-day::-webkit-scrollbar {width: 6px; height: 6px; background-color: rgb(220, 220, 220);}  /* calendar slider size, background */
    .leaflet-popup-scrolled::-webkit-scrollbar {width: 3px; height: 3px; background-color: rgb(220, 220, 220);}  /* popup slider size, background */

    .cld-main {position: relative; width: 100%; height: 0; padding-bottom: 60%; }
    .cld-main a {color: rgb(255, 0, 0);}
    .cld-datetime {max-width: 250px; margin: auto; overflow: hidden;}
    .cld-datetime .today {position: relative; float: left; width: calc(100% - 40px); margin: auto; text-align: center;}
    .cld-nav svg {fill: rgb(220, 220, 220);}
    .cld-nav:hover svg {fill: rgb(57, 115, 172);}
    .cld-nav:hover {cursor: pointer;}
    .cld-rwd {float: left;}
    .cld-fwd {float: right;}
    .cld-labels, .cld-days {padding-left: 0;}
    .cld-label, .cld-day {box-sizing: border-box; display: inline-block; width: calc(100%/7); text-align: center;}
    .cld-day {display: block; float: left; position: relative; margin: 0; padding: 3px; height: 68px; border: 1px solid rgb(220, 220, 220); overflow-y: auto;}
    .cld-day.today {border: 1px solid rgb(255, 0, 0);}
    .cld-day.nextMonth, .cld-day.prevMonth {opacity: 0;}
    .cld-number {font-size: 12.5px; margin: 0; text-align: left;}
    .cld-title {font-size: 11px; margin: 0; display: block; font-weight: normal;}
    .cld-day:hover {background: rgb(45, 51, 57);}
    .cld-number.eventday {font-weight: bold;}
    .cld-number.eventday:hover {background: rgb(45, 51, 57);}

    button {cursor: pointer;}
    input[type=range] {-webkit-appearance: none; opacity: 0.75;}
    input[type=range]::-webkit-slider-thumb {-webkit-appearance: none; appearance: none; width: 1rem; height: 1rem; border-radius: 0.5rem; background: rgb(57, 115, 172); margin-top: -0.35rem;}
    input[type=range]::-webkit-slider-runnable-track {height: 0.25rem; background-color: rgb(220, 220, 220); cursor: pointer;}
    input[type=range]:focus::-webkit-slider-thumb {box-shadow: 0 0 0 1px rgb(255, 255, 255), 0 0 0 0.2rem rgba(13, 110, 253, 0.2);}
    input[type=checkbox] {accent-color: rgb(57, 115, 172);}
    input[type=date] {background-color: rgb(220, 220, 220); font-family: "Noto Sans"; cursor: pointer;}

    @media (max-width: 26em) {.mobileSqueeze > tbody > tr > td {display: block;}}
    @media (orientation:landscape) and (max-width: 800px) {#map {height: 80vh;}}

    .control-font {
      font-size: 0.95rem;
      font-weight: 300;
    }

    button.colored {
      all: unset;
      color: rgb(100, 100, 100);
      border: 1px solid rgb(100, 100, 100);
      box-sizing: border-box;  /* include border in width */
      text-align: center;
      cursor: pointer;
      transition: 0.3s;
    }
    button.colored.on {
      color: rgb(255, 255, 255);
      background-color: rgba(57, 115, 172, 0.5);
    }
    button.colored.big {
      width: 7em;
      line-height: 2em;
      margin: 5px;
    }
    table button.colored {
      width: 100%;
    }

    .flex-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      column-gap: 12px;
      margin-top: 5px;
    }
    .flex-cell {
      width: 250px;
    }
    .flex-cell > * tr {
      height: 26px;
    }
  </style>

  <script>
    let locationDefault = [39.50, -98.35];  // Central US or GPS location
    let isGPSLocation = false;
    let searchRadius, minDate, maxDate;
    let lastOpenedTrack, selectedMonth;
    const infiniteRadius = 0;
    const radiusValues = [50, 100, 150, 200, 250, 300, 400, 500, 750, infiniteRadius];
    const vehicleTypeMap = {"M": "Moto", "S": "Sumo", "C": "Car"};
    const eventTypeMap = {"T": "TD", "S": "School", "R": "Race"};
    const homeImgMoto = `<svg xmlns="http://www.w3.org/2000/svg" fill="#ff0000" viewBox="0 0 64 64"><path d="M53 44a9 9 0 0 0-7 3l-1-1h1v-1l13-6a4 4 0 0 0-1-2c2-2 2-5 2-5v-2h-2l-6 1-3 1-1-3s-6-6-12-8c2-1 2-3 2-7 0-6-5-12-12-12a12 12 0 0 0-13 14c-1 0 1 6 3 6 2 5 4 6 6 6l4-1v4l-2 1-1-2h-1c-5 0-9 2-12 6l-2 4 1 2 2 1a10 10 0 0 0-6 2h1a9 9 0 0 0 5 17c4 0 8-3 9-6a3 3 0 0 0 3 3l19-3h1v-2a9 9 0 0 0 0-1 15 15 0 0 1 0-1 9 9 0 0 0 0 1c0 5 4 9 10 9s9-4 9-9-4-9-9-9m-8-5c4-3 1-5 8-7h5s0 4-3 5c-7 4-12 4-12 4l2-2m-7 5a4 4 0 0 1 1 2l-2 2 1-4M25 25l-3 1c-2 0-3-2-4-4l10-6 2-2-2-2-2 1-11 2a8 8 0 0 1 0-1c0-5 5-10 11-10s10 5 10 10 0 5-7 9a255 255 0 0 0-4 2m-1 12 1-1 6-2a2 2 0 0 0 0-2v-2l4 4h-1l-4 1-2 1-2 2v1a70 70 0 0 0-2-1v-1m10-1-1 4h-2a45 45 0 0 0-3-1v-1l1-1 5-1m-14-3a1 1 0 0 1 2 0v2c1 2 1 2-2 3h-1l-1-1c-1-2 0-3 1-3l1-1m-4 20h2a6 6 0 0 1-1 3l-1-1a5 5 0 0 1-1 1h2a7 7 0 0 1-2 2l-1-2a5 5 0 0 1-1 1l1 2a7 7 0 0 1-2 0v-2h-1v2a7 7 0 0 1-2 0l1-2a5 5 0 0 1-1-1l-1 2a7 7 0 0 1-2-2h2a5 5 0 0 1-1-1l-2 1a6 6 0 0 1 0-3h2v-1H5a6 6 0 0 1 0-2l2 1 1-1-2-1a7 7 0 0 1 2-2l1 2a5 5 0 0 1 1 0l-1-2a7 7 0 0 1 2-1v2h1v-2a7 7 0 0 1 2 1l-2 3a3 3 0 0 0-1 0c-1 0-2 1-2 3s1 3 2 3c2 0 3-2 3-3l-1-2 2-3 2 1-2 1 1 1 1-1 1 2h-2v1m25 1v1l-18 2-1-1-1-8-3-2-8-6 1-3a12 12 0 0 1 7-5v1l-2 2-1 1c0 1-2 2 0 2l2 1a3 3 0 0 0 2 1l2-1a56 56 0 0 1 11 3l-1 6h-1a4 4 0 0 0-1 0l-1-1-6-4h-1l1 1 4 3 2 1-2 2 8 2c1 1 2 0 2-1v-1c3 0 2-2 4-2h2l-1 6m0-9-1-1 4-1a25 25 0 0 0 3-1l-2 1-4 2m8 2v1h-1l1-1m8 6h2a6 6 0 0 1 0 3l-2-1a5 5 0 0 1-1 1h2a7 7 0 0 1-2 2l-1-2-1 1 2 2a7 7 0 0 1-3 0v-2h-1v2a7 7 0 0 1-2 0l1-2a5 5 0 0 1-1-1l-1 2a7 7 0 0 1-2-2h2a5 5 0 0 1-1-1l-1 1a6 6 0 0 1-1-3h1l4 2a3 3 0 0 0 2 1l2-3c0-2-1-3-2-3l-3-1h1l-1-2a7 7 0 0 1 2-1v2h1c1 0 0 0 0 0v-2a7 7 0 0 1 2 1l-1 2h1l1-2a7 7 0 0 1 2 2l-2 1 1 1 2-1v2h-2v1"/></svg>`
    const homeImgCar = `<svg xmlns="http://www.w3.org/2000/svg" fill="#ff0000" viewBox="0 0 64 64"><path d="M62 45.3 60 41l-5 3-.2-.2 4.8-2.9c1.6-1.2 1.6-4.3-.2-7-1.7-2.7-4.5-3.9-6.1-2.7L48.9 34l-.4.2c-.7.6-.9 1.9-.7 3.2l-.1-.1v-3.8l-4.4-7-2.6-1.6.5-.3c2-1.4 1.8-5-.2-8-2-3.2-5.2-4.6-7-3.2l-9 5.3.2 1.1-.7.4L19 18v-1.2l7.7-4-4-3.7L2 16.8l6.1 5.6 6.9-3.6v1.8l3.6 2.7-1.7 1-2.4-.6-3.6 2.1v.6l-5.4 3.2-.5.3c-2 1.4-1 6.5.7 9 1.7 2.6 3.9 4.2 5.8 4.2a3 3 0 0 0 1.8-.6l5.7-3.3a3 3 0 0 0 .4-.3 3.3 3.3 0 0 0 .9-1l5 3.8 6.5 1.5-.3.1c-1.8 1.3-.8 5.8.6 8 1.5 2.3 3.4 3.7 5.1 3.7a3 3 0 0 0 1.6-.5l4.7-2.8L49 54l13-8.7m-3.4-3 1.7 3.6-1 .8-2-3.7 1.3-.7M21.1 10l3.5 3.4-1.4.6-3.8-3.4 1.7-.6M10.9 20.5 5.2 16l2.4-.9 5 4.5-1.7.9M49.1 35a1.5 1.5 0 0 1 1-.3c1 0 2.5.8 3.8 2.7 1.5 2.3 1.4 4.8.4 5.6l-.3.2-1.5-1.4a1.2 1.2 0 0 0 .9-.2c.9-.7.8-2.3-.1-3.8-1-1.4-2.4-2-3.3-1.4-.6.5-.6 1.4-.2 2.4l1.4-.8c1-.5 2.1.8 1.5 1.7l-1.5.9-2.1-2c-.5-1.6-.5-3.2 0-3.6M49 47.7l-4 2.4c.6-1.2.6-2.8 0-4.5l3.9 2.1m-4-3.5-.3.2a10.4 10.4 0 0 0-.7-1.2 10.7 10.7 0 0 0-.5-.7c1-.5 2.1.7 1.5 1.7m-16.6-27 14.3 9.5 4.4 7-1.2.7-4.4-7-14.3-9.5 1.2-.7m9 13.6.4-.2c-.5 1.7-1.6 2.6-3.8 2.6-2.8 0-6.4-1.5-6.4-4.5s2.3-5.4 5.2-5.4a5 5 0 0 1 5 4.3c0-.2-.2-.2-.3-.2-2.9.2-6.7.1-6.8 1.2-.1 1.1 2.2 2.5 6.8 2.2M16 19.8v-1.6l2-1v1.4l11.5 4.5-3.4 1.6-10-4.8m-1.7 6c-.7-.3-1.5-.3-2.2-.2l1.1-.6 1.1.8m-3 16.2c-1.5 0-3.4-1.4-5-3.7-1.4-2.3-2.2-6.7-1-7.7.5-.2 1-.4 1.4-.4 1.8 0 3.9 1.5 5.3 3.7 2 3 2.2 6.5.5 7.7a2 2 0 0 1-1.2.4m13.7-6.3-4.7-3.3a11.5 11.5 0 0 0-2.6-4.3l9.6 6.4 11 4.4-1.7 1-11.6-4.2m12 18.2c-1.3 0-3-1.3-4.2-3.3-1.5-2.1-2-5.8-1-6.6l1.2-.3c1.5 0 3.3 1.3 4.5 3.2 1.7 2.6 2 5.6.5 6.7-.3.2-.6.3-1 .3m10-4.8 4.1 2.8-1 .8-4.4-2.8 1.4-.8"/><path d="M7 32.9c-1.2.8-.7 3 .5 4.8 1.2 1.9 2.7 2.7 3.8 1.9 1.2-.8 1.1-3 0-4.9C10 33 8 32 6.8 33m26.4 13c-1 .7-.6 2.6.5 4.2 1 1.7 2.4 2.4 3.4 1.7s1-2.7-.1-4.3c-1.1-1.6-2.8-2.4-3.8-1.7"/></svg>`
    const homeIconMoto = L.divIcon({html: homeImgMoto, className: "", iconSize: [36, 36], iconAnchor: [18, 18]});
    const homeIconCar = L.divIcon({html: homeImgCar, className: "", iconSize: [50, 50], iconAnchor: [25, 25]});

    function getGPSLocation() {
      function setGPSLocation(position) {
        locationDefault = [position.coords.latitude, position.coords.longitude];
        isGPSLocation = true;
        if (typeof tracks !== "undefined") {resetHome();}
      }
      navigator.geolocation?.getCurrentPosition(setGPSLocation);
    }

    function resetHome() {
      homeMarker.setLatLng(locationDefault);
      searchCircle.setLatLng(locationDefault);
      map.setView(locationDefault, isGPSLocation ? 6 : 3);
      radiusSliderElement.value = isGPSLocation ? "3" : "9";
      L.popup(locationDefault, {"content": "<b>Drag Me</b>", "className": "dragMe", "autoPan": false, "closeButton": false, "offset": [0, 50]}).openOn(map);

      updateTrackDistances();
      updateSearchRadius(radiusValues[radiusSliderElement.value]);
      updateTrackdaysVisibilityProperty();
      updateTrackIcons(true);
      updateTrackPopup();
      selectedMonth = undefined;  // updateCalendar updates to current month
      updateCalendar();
      updateDropdown();
    }

    function updateTrackDistances() {
      function milesBetween(lat1, lon1, lat2, lon2) {
        function deg2rad(deg) {return deg * (Math.PI/180);}
        let r = 6371;  // earth radius km
        lat1 = deg2rad(lat1);
        lat2 = deg2rad(lat2);
        let deltaLat = lat2 - lat1;
        let deltaLon = deg2rad(lon2 - lon1);
        let a = Math.pow(Math.sin(deltaLat / 2), 2) + Math.cos(lat1) * Math.cos(lat2) * Math.pow(Math.sin(deltaLon / 2), 2);
        let d = 2 * r * Math.asin(Math.sqrt(a));
        return d * 0.621371;
      }
      let {lat, lng} = homeMarker.getLatLng();
      Object.keys(tracks).forEach((track) => {
        tracks[track]["dist"] = milesBetween(lat, lng, tracks[track].lat, tracks[track].lon);
      });
      trackdays.sort((a, b) => tracks[a.track].dist - tracks[b.track].dist);  // keep sorted for calendar order
    }

    function updateTrackIcons(updateTrackVisibility) {
      let allTracks = Object.keys(tracks);
      let tracksWithEvents = new Set(trackdays.filter(td => td.visibilityMap).map(td => td.track));

      if (updateTrackVisibility) {
        allTracks.forEach(track => {  // track visibility based on event type
          [...tracks[track].vehicleType].some(t => selectedVehicleTypes.has(t)) ? mapMarkers[track].addTo(map) : mapMarkers[track].remove();
        });
        if (!showTracksWithoutEventsToggleElement.classList.contains("on")) {  // trackday visibility based on event type
          let tracksWithoutEvents = allTracks.filter((track) => !tracksWithEvents.has(track));
          tracksWithEvents.forEach((track) => {mapMarkers[track].addTo(map);});
          tracksWithoutEvents.forEach((track) => {mapMarkers[track].remove();});
        }
      }

      allTracks.forEach((track) => {
        let withinRadius = (searchRadius === infiniteRadius || tracks[track].dist <= searchRadius);
        opacityMultiplier = tracksWithEvents.has(track) ? 1.0 : 0.35;
        if (withinRadius) {
          mapMarkers[track].setIcon(trackIconCheckered);
          mapMarkers[track].setOpacity(0.8 * opacityMultiplier);
        } else {
          mapMarkers[track].setIcon(trackIconRed);
          mapMarkers[track].setOpacity(0.6 * opacityMultiplier);
        }
      });
    }

    function updateSearchRadius(radiusMiles) {
      searchRadius = radiusMiles;
      searchCircle.setRadius(searchRadius * 1609.34);
      document.getElementById("displayedRadius").innerText = (searchRadius === infiniteRadius ? `∞` : `${searchRadius}`);
    }

    function updateTrackdaysVisibilityProperty() {
      let maxPrice = priceSliderElement.value;
      let selectedDays = new Set(Array.from(daySelectElement.options).filter(option => option.selected).map(option => option.value));
      trackdays.forEach((td) => {
        let withinRadius = (searchRadius === infiniteRadius || tracks[td.track].dist <= searchRadius);
        let dateCheck = ((!minDate.isValid() && !maxDate.isValid()) || 
                         (!minDate.isValid() && td.date.isBefore(maxDate)) || 
                         (td.date.isAfter(minDate) && !maxDate.isValid()) || 
                         (td.date.isAfter(minDate) && td.date.isBefore(maxDate)));
        let priceCheck = (isNaN(maxPrice) || (td.price <= maxPrice));
        let dayCheck = selectedDays.has(dayjs(td.date).format("ddd"));
        let vehicleTypeCheck = [...td.vehicleType].some(t => selectedVehicleTypes.has(t));
        let eventTypeCheck = [...td.eventType].some(t => selectedEventTypes.has(t));
        let orgSelectCheck = orgs[td.org].dropdownSelected;
        td.visibilityDropdown = (withinRadius && vehicleTypeCheck && eventTypeCheck);
        td.visibilityMap = (dateCheck && priceCheck && dayCheck && vehicleTypeCheck && eventTypeCheck && orgSelectCheck);
        td.visibilityCalendar = (td.visibilityMap && withinRadius);
      });
    }

    function updateTrackPopup() {
      if (lastOpenedTrack === undefined) {return;}
      let track = tracks[lastOpenedTrack];
      let trackdaysFiltered = trackdays.filter(td => td.track === lastOpenedTrack);
      let numTrackdaysBeforeFilter = trackdaysFiltered.length;
      trackdaysFiltered = trackdaysFiltered.filter(td => td.visibilityMap);
      let numTrackdaysHidden = numTrackdaysBeforeFilter - trackdaysFiltered.length;
      let hasSubtracks = trackdaysFiltered.some(td => td.subtrack);
      let multipleVehicleTypes = (selectedVehicleTypes.size > 1);
      let multipleEventTypes = trackdaysFiltered.some(td => td.eventType != "T") & (selectedEventTypes.size > 1);
      let hasPrices = trackdaysFiltered.some(td => td.price !== -1);
      let hasNotes = trackdaysFiltered.some(td => td.note);
      let tbody = trackdaysFiltered.map(td => {return `
        <tr>
          <td><a href="${td.url}" target="_blank">${td.date.format("MM/DD")}</a></td>
          <td>${td.date.format("ddd")}</td>
          <td>${td.org}</td>
          ${multipleVehicleTypes ? `<td>${[...td.vehicleType].map(t => vehicleTypeMap[t]).join("/")}</td>` : ""}
          ${multipleEventTypes ? `<td>${[...td.eventType].map(t => eventTypeMap[t]).join("/")}</td>` : ""}
          ${hasSubtracks ? `<td>${td.subtrack ? td.subtrack : "-"}</td>` : ""}
          ${hasNotes ? `<td>${td.note ? td.note : "-"}</td>` : ""}
          ${hasPrices ? `<td>${td.price >= 0 ? '$' + td.price : "-"}</td>` : ""}
        </tr>
      `}).join("");
      let tbl = (trackdaysFiltered.length === 0 ? `No Events Found<br>` :
        `<table>
          <thead><tr>
          <th>Date</th>
          <th>Day</th>
          <th>Host</th>
          ${multipleVehicleTypes ? "<th>Vehicle</th>" : ""}
          ${multipleEventTypes ? "<th>Type</th>" : ""}
          ${hasSubtracks ? "<th>Circuit</th>" : ""}
          ${hasNotes ? "<th>Note</th>" : ""}
          ${hasPrices ? "<th>Price</th>" : ""}
          </tr></thead>
          <tbody>${tbody}</tbody>
        </table>`);
      mapMarkers[lastOpenedTrack].getPopup().setContent(
        `<div class="popup">
        <b class="allowSelect">${track.name}${track.showNickname ? " (" + track.nickname + ")" : ""}</b><br>
        <a href="https://www.google.com/maps?q=directions+${track.name}" target="_blank" title="Directions">${directionImg}</a>
        <a href="https://www.google.com/search?q=weather+${track.name}" target="_blank" title="Weather">${weatherImg}</a>
        <a href="https://www.youtube.com/results?search_query=${track.name}+track&sp=CAISAhAB" target="_blank" title="Videos">${videoImg}</a>
        <br>${tbl}${numTrackdaysHidden ? `<span style="font-size: 10px">Excluding ${numTrackdaysHidden} Filtered Events</span>` : ""}
        </div>`);
    }

    function updateCalendar() {
      // trackdays should be sorted by distance before this
      let calendarEvents = [];
      trackdays.forEach((td) => {
        if (td.visibilityCalendar) {
          let price = (td.price === -1 ? "" : "$" + td.price);
          let priceStr = (price ? " - " + price : "");
          let orgStr = (tracks[td.track].nickname === td.org ? "" : " - " + td.org)
          let subtrackStr = (td.subtrack ? " - " + td.subtrack : "");
          let noteStr = (td.note ? " (" + td.note + ")" : "");
          let calendarStr = `<a href=${td.url} target="_blank" title="${price}${subtrackStr}${noteStr}">• ${tracks[td.track].nickname}${orgStr}</a>`;
          calendarEvents.push({Date: td.date.toDate(), Title: calendarStr});
        }
      });
      calendar = document.getElementById("calendar");
      if (selectedMonth === undefined) {
        selectedMonth = dayjs().toDate();
      } else {
        let monthStr = calendar.getElementsByClassName("cld-datetime")[0].innerText  // get selected month from calendar html before deletion - super hacky, oh well
        selectedMonth = dayjs(monthStr, "MMMM YYYY").toDate();
      }
      calendar.innerHTML = "";  // delete old calendar
      calendarObj = caleandar(calendar, calendarEvents, {Color: "#999999", LinkColor: "#ffffff", NavShow: true, DateTimeShow: true}, selectedMonth);
      document.getElementById("numTrackdaysMatching").innerText = `${calendarEvents.length} matching events`
    }

    function updateDropdown() {
      let visibleOrgs = new Set(trackdays.filter(td => td.visibilityDropdown).map(td => td.org));
      // delete and recreate options so orgs are alphabetical
      orgSelectElement.options.length = 0;
      Object.values(orgs).filter(org => org.numEvents > 0).forEach((org) => {
        if (visibleOrgs.has(org.orgNickname)) {
          org.dropdownOption.selected = org.dropdownSelected;
          orgSelectElement.add(org.dropdownOption);
        }
      });
      orgSelectElement.loadOptions();
    }

    function updateMinDateVar() {
      minDate = dayjs(minDateElement.value + " 00:00").subtract(1, "s");
    } // str addition to avoid use of CustomParseFormat, add/subtract second for dayjs comparison

    function updateMaxDateVar() {
      maxDate = dayjs(maxDateElement.value + " 00:01");
    }

    let showSyncInfo = false;
    function toggleSyncInfo() {
      if (showSyncInfo) {
        document.getElementById("syncInfo").innerHTML = "";
        showSyncInfo = false;
      } else {
        let tbody = Object.values(orgs).map(org => {return `
          <tr>
            <td><a href="${org.url}" target="_blank" style="color:inherit;">${org.org}</a></td>
            <td>${org.numEvents}</td>
            <td>${dayjs().to(org.syncTimeUTC)}</td>
          </tr>
        `}).join("");
        let tbl = `
          <div style="column-width: 20rem;">
            <table class="center gray" style="font-size: 0.8rem;">
              <thead style="break-inside: avoid;"><tr>
                <th>Host</th>
                <th>Events</th>
                <th>Last Sync</th>
              </tr></thead>
              <tbody>${tbody}</tbody>
            </table>
          </div>`;
        document.getElementById("syncInfo").innerHTML = "<hr>" + tbl;
        showSyncInfo = true;
      }
    }
  </script>
</head>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-MG8WTWEELF"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {dataLayer.push(arguments);}
  gtag("js", new Date());
  gtag("config", "G-MG8WTWEELF");
</script>

<body onLoad="getGPSLocation();">
<div class="center container">
  <header style="margin-bottom: 1rem">
    <div>
      <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" fill="#ff0000" fill-opacity="1.0" viewBox="0 -125 950 950">
        <path d="m949.9 741.3-.2-6.2-.3-6.3v-4.3h-.1v-.4l-.2-2.6-.8-10.5-.2-2.6-.4-3.5-.6-6.8-.7-6.8-.3-3.4-.4-3c-1.2-8.3-2.2-16.4-3.6-24.2l-2-11.5-2.3-10.9c-1.4-7-3.2-13.7-4.7-19.8L932 614l-1.2-4.3-2.2-7.9-2-6.8-1.9-5.9-2-6.4a5 5 0 0 0-6-3.2L756 625.2a5 5 0 0 0-3.5 5.7l.6 3.2.8 4 .7 4.7.8 5.4.5 3 .3 3c.5 4.2 1.1 8.6 1.4 13.5l.6 7.3.4 7.7c.3 5.2.3 10.7.4 16.1v3.9l-.2 3.6v3.6l-.1 1.8-.1 2.6-.5 10.5-.1 2.6v.4-1.6.2l-.1.5-.1 1-.4 4.1c0 1.4-.2 2.7-.3 4l-.5 4-1 8-1 7.5c-.5 2.4-1 4.8-1.3 7.1l-1.3 6.8-1.3 6.2a10470.2 10470.2 0 0 1-2 8.4l-.5 2.1-.3 1.2h196.4a5 5 0 0 0 5-4.7c0-3.7.3-7.4.4-11.3l.3-11.7v-12.1l-.1-6.2zm-51.1-206.2a5 5 0 0 0 2.6-6.7l-1.9-4A3091.8 3091.8 0 0 1 894 513l-4-8-2-4-2.3-4-4.6-8.5a30131.6 30131.6 0 0 1-8-13.7l-3-4.7-6.1-9.7c-4.4-6.5-8.7-13.2-13.6-19.8l-3.6-5-1.8-2.5-1.9-2.4-7.6-9.8c-2.5-3.3-5.2-6.5-7.8-9.6l-4-4.8-4-4.6-4-4.5-4-4.5-8.1-8.6-8-8a184 184 0 0 0-7.8-7.6l-7.5-7c-2.5-2.4-5-4.4-7.2-6.5l-6.7-5.8-6.1-5-5.5-4.5-4.6-3.7-5.2-4a5 5 0 0 0-6.8.8L652 437.4a5 5 0 0 0 .3 6.6l2.5 2.5c.9.9 2 1.8 3 3l3.4 3.6 3.9 4 4.1 4.7 4.5 5 4.6 5.7a105 105 0 0 1 4.8 6c1.6 2 3.3 4 4.9 6.3a44407.1 44407.1 0 0 1 7.2 10l2.4 3.6 2.4 3.5 2.3 3.6 4.6 7.3 4.4 7.4 1 1.8 1 1.9c.8 1.2 1.5 2.5 2.1 3.7 2.8 4.9 5.2 10 7.7 14.7 1 2.4 2.2 4.8 3.3 7.1l1.6 3.5 1.5 3.4 2.8 6.6 2.4 6.2 1.1 2.9 1 2.7 1.6 4.6 1.4 4 1.6 4.7 1.4 4.2a5 5 0 0 0 6.5 3l149.5-60zm-439-186.4 4.3.6 5 1c1.9.2 3.8.6 5.8 1 1.8.2 3.6.6 5.5 1L534.8 241l-8-1.2-5.3-.8-5.2-.6-10-1.2-9.4-.8c-3-.3-5.8-.6-8.6-.7l-7.7-.4c-2.5 0-4.7-.2-6.8-.3a44344.6 44344.6 0 0 0-12-.2 5 5 0 0 0-5 4.7l-5 103.6a5 5 0 0 0 4.2 5.1l3.8.5zM606 405.8l4.2 3 3.6 2.6 2 1.5 2 1.4 3.5 2.6a5 5 0 0 0 7-1.2l71-108.2a5 5 0 0 0-1.6-7l-3.8-2.2-2.1-1.2-2.5-1.4-6.6-3.6-7.4-4-7.9-4c-2.7-1.3-5.5-2.8-8.6-4.2l-9.2-4.2c-3.2-1.5-6.5-2.9-10-4.3-3.3-1.4-6.7-3-10.3-4.3l-2.7-1-30.7 133 4.9 3.2 5.2 3.5zm-241.6-57.6 4.1-.5a3448.5 3448.5 0 0 0 11.6-1.2l7.1-.5 3.4-.2 3.1-.2 5.5-.2 4.8-.1h9.4a5 5 0 0 0 5-5.3l-6.5-97.6a5 5 0 0 0-5.5-4.6l-4.4.6-5 .6-7.2 1-8 1.3-4.2.8-4.3.8-9 1.7-9.7 2.2-5 1.2-5.1 1.3-10.5 2.8-10.8 3.2-5.4 1.7-5.5 1.9-5.5 1.9c-1.8.6-3.7 1.2-5.5 2l-11 4.1-10.8 4.5-5.3 2.3-5.3 2.4-5.2 2.5-5.1 2.4-10 5c-3.2 1.6-6.3 3.5-9.4 5.1l-8.9 5-8.3 5-7.7 4.8-7 4.5c-2.2 1.5-4.2 3-6.2 4.2l-5.4 3.8c-1.7 1.1-3.1 2.3-4.5 3.3l-4.7 3.4a5 5 0 0 0-1.1 6.8l40.5 59.5a5 5 0 0 0 6.5 1.6l3.6-2.1c1.2-.7 2.5-1.5 4-2.2l4.8-2.5 5.4-2.8 6-3 6.7-3.1c2.4-1 4.8-2 7.2-3.2l7.7-3.1c2.6-1 5.2-2.2 8-3.2l8.4-3 4.3-1.4 4.3-1.4 4.4-1.4 4.4-1.3c3-.8 6-1.8 9-2.5l9-2.3 4.5-1 4.4-1 4.5-.8 4.4-.8 8.6-1.5 8.4-1.2zm-276.2 77-3.2 4.5-3.2 4.6-3.2 4.7-6.1 9.4-6 9.6-1.4 2.4-1.4 2.4-2.7 4.8c-3.7 6.4-7 12.9-10.3 19l-4.5 9.3-2.2 4.5-2 4.4-3.8 8.5-3.4 8-3 7.5a11856.4 11856.4 0 0 1-4.7 12.7l-1.7 5-1.8 5.2a5 5 0 0 0 3 6.2l37.6 14.4a5 5 0 0 0 6.3-2.4l2-4.1 2-4.3 2.6-5 3-5.7 3.4-6.2 3.7-6.7 4.3-7 2.2-3.7 2.4-3.7 4.9-7.6c3.5-5 7-10.3 11-15.4l2.8-3.9 1.5-2 1.5-1.9 6-7.6 6.3-7.4c1-1.3 2-2.5 3.2-3.7l3.2-3.6a10712.4 10712.4 0 0 0 6.4-7l6.4-6.6c2.1-2.2 4.3-4.2 6.4-6.2 2-2 4-4 6.2-5.9l6-5.4c1.8-1.8 3.8-3.3 5.6-5l5.2-4.4 4.7-3.7 4-3.2 2-1.5a1416.5 1416.5 0 0 1 5.5-4.1 5 5 0 0 0 .8-7.2l-43-50.3a5 5 0 0 0-7.1-.3c-1 .8-2 1.9-3.2 3l-1.7 1.7-2 2-4.8 4.7-5.4 5.5-5.5 6-6 6.6-6.2 7.2-6.4 7.7-6.5 8.2a19619.3 19619.3 0 0 0-9.7 13zm-78 176.4-1 4.3-1 5-1 6.2-1.3 7.2-.6 3.9-.6 4c-.7 5.4-1.6 11.3-2.1 17.6l-1 9.6-.7 10c-.5 6.9-.6 14-.8 21l-.1 2.8v2.6a220415.3 220415.3 0 0 1 0 10.9v2.7l.2 2.7.4 10.9.1 2.7v.8l.1.7.1 1.3.4 5.2.4 5.1.5 5.3.5 5.3.3 2.5c0 .9.2 1.7.3 2.6l1.3 9.8 1.4 9.5c.4 3 1 6 1.5 8.8l.2.7a5 5 0 0 0 4.8 4h13.3a5 5 0 0 0 5-5.2l-.2-2.3-.5-8.5-.3-9a40192 40192 0 0 1 0-11.8V748l.1-4.8.1-4.9.3-5.1.2-5.2v-1.3l.1-.7c0-.3 0 .1 0 0v-.4l.3-2.5.8-10.1.2-2.6.3-2.5.5-5 .6-5 .3-2.5.4-2.5c1-6.5 1.8-13 3.1-19.2l1.7-9.1 2-8.7c1.1-5.6 2.6-10.9 3.9-15.7l.9-3.6 1-3.3 1.8-6L50 622l1.6-4.8L53 613a5 5 0 0 0-3.4-6.3l-33.3-8.9a5 5 0 0 0-6.1 3.8zm377.1 172.7A76.4 76.4 0 0 0 490 739c2.6-5.3 4.5-11 5.8-16.5l77.6-336.7L603 257.6l18.3-79.4c2-9.2-5.3-15.5-12.6-15.5a12 12 0 0 0-11.1 7.1L560.2 246l-55 112.4-153.1 313.3c-18.6 38-2.8 84 35.2 102.6zm36.5-108.5a37.6 37.6 0 1 1 0 75.2 37.6 37.6 0 0 1 0-75.2z"/>
      </svg>
      <h1 class="gray"><b>Trackdays</b>.fyi</h1>
      <h5>One stop to find trackdays near you</h5>
    </div>
  </header>

  <main>
    <div class="lead">
      <div id="eventInfoText" style="display:none">
        <span>Tracking <span id="numTrackdays"></span> events from <span id="numOrgs"></span> organizers.</span>
        <br>
        <span>Last sync was <b><a id="lastSyncMessage" onclick="toggleSyncInfo();" href="javascript:void(0);" style="color:inherit; text-decoration-thickness: 1px;"></a></b>.</span>
      </div>
      <div id="eventInfoSpinner" style="display:block">
        <span>Loading events...</span>
        <br>
        <img src="loading.gif">
      </div>
    </div>

    <p id="syncInfo"></p>
    <hr style="margin: 0rem;">

    <table class="center mobileSqueeze control-font">
      <td><button type="button" class="colored big" id="showCarEvents">Car</button></td>
      <td><button type="button" class="colored big" id="showMotoEvents">Motorcycle</button></td>
      <td><button type="button" class="colored big" id="showSumoEvents">Supermoto</button></td>
    </table>

    <div id="map"></div>

    <div class="flex-row control-font">
      <table class="flex-cell">
        <tr>
          <td colspan="4"><select multiple id="orgSelect" multiselect-search="true" multiselect-select-all="true" 
            data-txtNothingSelected="No Hosts Selected" data-txtNothingAvailable="No Hosts Found" 
            data-txtSelectedSuffix="hosts selected" data-txtSearch="Search Hosts" data-height="16rem"></select></td>
        </tr>
        <tr>
          <td>Travel</td>
          <td><input id="radiusSlider" type="range" min="0" value="9" max="9" step="1" style="vertical-align: middle;"></td>
          <td>≤</td>
          <td><span id="displayedRadius" style="display: inline-block; width: 3ch; text-align: center;"></span> mi</td>
        </tr>
        <tr>
          <td>Price</td>
          <td><input id="priceSlider" type ="range" min="100" max="500" step="20" value="500" style="vertical-align: middle;"/></td>
          <td>≤</td>
          <td>$<span id="displayedPrice" style="display: inline-block; width: 3ch; text-align: center;"></td>
        </tr>
      </table>

      <table class="flex-cell">
        <tr>
          <td><input id="minDateSearch" type="date" value="" min="" max=""> - <input id="maxDateSearch" type="date" value="" min="" max=""></td>
        </tr>
        <tr>
          <td><select multiple id="daySelect" multiselect-search="false" multiselect-select-all="true" style="width: 100%;"
            data-txtNothingSelected="No Days Selected" data-txtSelectedSuffix="days selected" data-height="11.1rem">
            <option selected value="Sun">Sunday</option>
            <option selected value="Mon">Monday</option>
            <option selected value="Tue">Tuesday</option>
            <option selected value="Wed">Wednesday</option>
            <option selected value="Thu">Thursday</option>
            <option selected value="Fri">Friday</option>
            <option selected value="Sat">Saturday</option>
          </select></td>
        </tr>
        <tr>
          <td><button type="button" class="colored on" id="showTracksWithoutEvents">Show Tracks without Events</button></td>
        </tr>
      </table>

      <table class="flex-cell" style="display: none;">
        <tr>
          <td><button type="button" class="colored on" id="showTrackdays">Show Trackdays</button></td>
        </tr>
        <tr>
          <td><button type="button" class="colored" id="showSchools">Show Track Schools</button></td>
        </tr>
        <tr>
          <td><button type="button" class="colored on" id="showRaces">Show Races</button></td>
        </tr>
      </table>

      <table class="flex-cell">
        <tr>
          <td><span id="numTrackdaysMatching"></span></td>
        </tr>
        <tr>
          <td><button id="resetFilters" type="button">Reset</button></td>
        </tr>
      </table>
    </div>

    <hr>
    <div id="calendar"></div>
    <hr>
  </main>

  <footer class="gray" style="margin: 0; font-size: 0.7rem;">
    <p>No guarantee of event availability, pricing accuracy, or completeness. Contact hosts for up-to-date information.</p>
    <p>To report inaccuracies or bugs: <b class="allowSelect">trackdaysFYI@gmail.com</b></p>
    <p>© 2023-2025 Trackdays.fyi</p>
  </footer>

  <script>
    var map = L.map("map", {doubleClickZoom: false, boxZoom: false, minZoom: 4, maxZoom: 15, worldCopyJump: true});
    let tiles = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", 
      {attribution: `<a style="font-size:9px" href="http://www.openstreetmap.org/copyright">&copy; OpenStreetMap</a>`}
    ).addTo(map);
    map.attributionControl.setPrefix("");

    let homeMarker = L.marker(locationDefault, {icon: homeIconMoto, opacity: 0.9, draggable: true, autoPan: true, autoPanSpeed: 1, zIndexOffset: 1000}).addTo(map);
    let searchCircle = L.circle(locationDefault, {stroke: true, color: "#ff0000", opacity: 0.4, dashArray: "4", fill: false, interactive: false, radius: infiniteRadius}).addTo(map);

    let showMotoEventsButton = document.getElementById("showMotoEvents");
    let showSumoEventsButton = document.getElementById("showSumoEvents");
    let showCarEventsButton = document.getElementById("showCarEvents");
    let orgSelectElement = document.getElementById("orgSelect");
    let radiusSliderElement = document.getElementById("radiusSlider");
    let priceSliderElement = document.getElementById("priceSlider");
    let displayedPriceElement = document.getElementById("displayedPrice");
    let minDateElement = document.getElementById("minDateSearch");
    let maxDateElement = document.getElementById("maxDateSearch");
    let daySelectElement = document.getElementById("daySelect");
    let showTracksWithoutEventsToggleElement = document.getElementById("showTracksWithoutEvents");
    let showTrackdaysToggleElement = document.getElementById("showTrackdays");
    let showSchoolsToggleElement = document.getElementById("showSchools");
    let showRacesToggleElement = document.getElementById("showRaces");
    let resetElement = document.getElementById("resetFilters");

    orgSelectElement.style.display = "block";
    MultiselectDropdown();

    minDateElement.min = dayjs().subtract(1, "d").format("YYYY-MM-DD");
    minDateElement.max = dayjs().add(1, "y").format("YYYY-MM-DD");
    maxDateElement.min = dayjs().subtract(1, "d").format("YYYY-MM-DD");
    maxDateElement.max = dayjs().add(1, "y").format("YYYY-MM-DD");
    minDateElement.value = dayjs().format("YYYY-MM-DD");
    maxDateElement.value = "";
    updateMinDateVar();
    updateMaxDateVar();

    const checkeredFlagImg = `<svg xmlns="http://www.w3.org/2000/svg" fill="#000000" viewBox="0 0 24 24"><path d="M4 2v18H3v2h4v-2H6v-5h13a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1H6V2H4zm4 3v2h2V5h2v2h2V5h2v2h2v2h-2v2h2v2h-2v-2h-2v2h-2v-2h-2v2H8v-2H6V9h2V7H6V5h2z"/><path d="M8 9h2v2H8zm4 0h2v2h-2zm-2-2h2v2h-2zm4 0h2v2h-2z"/></svg>`;
    const directionImg = `<svg xmlns="http://www.w3.org/2000/svg" width="22px" height="22px" viewBox="0 0 24 24"><path d="m2.3 12.7 9 9c.4.4 1 .4 1.4 0l9-9a1 1 0 0 0 0-1.4l-9-9a1 1 0 0 0-1.4 0l-9 9a1 1 0 0 0 0 1.4zM9 10h5V8l3 3-3 3v-2h-3v4H9v-6z"/></svg>`;
    const weatherImg = `<svg xmlns="http://www.w3.org/2000/svg" width="22px" height="22px" viewBox="0 0 24 24"><path d="M7 12a5 5 0 1 0 10 0 5 5 0 0 0-10 0zm4 7h2v3h-2zm0-17h2v3h-2zm-9 9h3v2H2zm17 0h3v2h-3zM5.6 19.8l-1.4-1.4 2.1-2.2 1.5 1.5zM16.2 6.3l2.2-2 1.4 1.3-2.1 2.2zM6.3 7.8l-2-2.2 1.3-1.4 2.2 2.1zm13.5 10.6-1.4 1.4-2.2-2.1 1.5-1.5z"/></svg>`;
    const videoImg = `<svg xmlns="http://www.w3.org/2000/svg" width="22px" height="22px" viewBox="0 0 24 24"><path d="m18 7-2-2H4L2 7v10l2 2h12l2-2v-3l4 3V7l-4 3V7z"/></svg>`;

    const trackIconCheckered = L.divIcon({html: checkeredFlagImg, className: "", iconSize: [32, 32], iconAnchor: [16, 16], popupAnchor: [0, -12]});
    const trackIconRed = L.divIcon({html: checkeredFlagImg.replace("#000000", "#ff0000"), className: "", iconSize: [32, 32], iconAnchor: [16, 16], popupAnchor: [0, -12]});

    let orgs, trackdays;
    let selectedVehicleTypes = new Set();
    let selectedEventTypes = new Set();
    let minObservedPrice, maxObservedPrice;
    let mapMarkers = new Object();

    async function visualizeData() {
      try {
        const res = await fetch("https://atqtpmna66.execute-api.us-east-1.amazonaws.com/getTrackdays");
        const data = await res.json();
        orgs = data["orgs"];
        tracks = data["tracks"];

        document.getElementById("eventInfoText").style.display = "block";
        document.getElementById("eventInfoSpinner").style.display = "none";

        tracks = tracks.reduce((obj, v) => {obj[v["nickname"].toUpperCase()] = v; return obj;}, {})  // reformat tracks to be object
        orgs = orgs.map(org => ({...org, 
          numEvents: org.events.length,
          events: org.events.map(e => ({...e, org: org.orgNickname, url: e.url || org.url}))}));  // add org key and default url
        trackdays = orgs.flatMap(({events}) => events);  // aggregate events as single list
        trackdays = trackdays.map(td => ({...td, date: dayjs(td.date, "YYYY-MM-DD")}));  // convert date string to dayjs
        trackdays.sort((a, b) => (a.date > b.date ? 1 : -1));  // sort by date

        const idx = trackdays.findIndex(td => td.date >= dayjs().startOf("day"));  // remove trackdays prior to current day
        trackdays = trackdays.slice(idx);

        orgs = orgs.map(({events, ...item}) => item);  // drop events key
        orgs = orgs.map(org => ({...org,
          syncTimeUTC: dayjs.utc(org.syncTimeUTC),
          dropdownOption: new Option(org.org, org.orgNickname),
          dropdownSelected: (org.numEvents > 0),
        }));
        orgs.sort((a, b) => (a.org > b.org ? 1 : -1));  // sort by name

        let lastSync = orgs.reduce((prev, curr) => prev.syncTimeUTC.isAfter(curr.syncTimeUTC) ? prev : curr).syncTimeUTC;
        document.getElementById("lastSyncMessage").innerText = dayjs().to(lastSync);
        document.getElementById("numTrackdays").innerText = trackdays.length;
        document.getElementById("numOrgs").innerText = new Set(trackdays.map(a => a.org)).size;  // num unique orgs

        orgs = orgs.reduce((result, org) => {  // map org nickname -> org
          result[org.orgNickname] = org;
          return result;
        }, {});

        // update price slider limits
        minObservedPrice = Math.min(...trackdays.map(td => td.price));
        maxObservedPrice = Math.max(...trackdays.map(td => td.price));
        minObservedPrice = Math.ceil(minObservedPrice / 20) * 20;  // round up 20
        maxObservedPrice = Math.ceil(maxObservedPrice / 20) * 20;  // round up 20
        priceSliderElement.min = minObservedPrice;
        priceSliderElement.value = priceSliderElement.max = displayedPriceElement.innerText = maxObservedPrice;

        // create track markers
        Object.keys(tracks).forEach((trackName) => {
          track = tracks[trackName];
          mapMarkers[trackName] = L.marker([track.lat, track.lon], {title: track.nickname, icon: trackIconCheckered, opacity: 0.8});
          mapMarkers[trackName].bindPopup("", {maxHeight: 280, maxWidth: 420, closeButton: false});  // popup content updated on click
          mapMarkers[trackName].on("mousedown", (e) => {
            lastOpenedTrack = e.target.options.title.toUpperCase();
            updateTrackPopup();
          });
        });

        homeMarker.on("drag", (e) =>{
          map.closePopup();  // close "Drag Me" popup
          searchCircle.setLatLng(e.latlng);
        });

        homeMarker.on("dragend", () => {
          updateTrackDistances();
          updateTrackdaysVisibilityProperty();
          updateTrackIcons(false);
          updateCalendar();
          updateDropdown();
        });

        radiusSliderElement.addEventListener("input", () => {
          updateSearchRadius(radiusValues[radiusSliderElement.value]);
          updateTrackIcons(false);
        });

        radiusSliderElement.addEventListener("change", () => {
          updateTrackdaysVisibilityProperty();
          updateCalendar();
          updateDropdown();
        });

        priceSliderElement.addEventListener("input", () => {
          displayedPriceElement.innerText = priceSliderElement.value;
        });

        minDateElement.addEventListener("input", () => {
          updateMinDateVar();
        });

        maxDateElement.addEventListener("input", () => {
          updateMaxDateVar();
        });

        orgSelectElement.addEventListener("change", () => {
          Array.from(orgSelectElement.options).forEach((opt) => {
            orgs[opt.value].dropdownSelected = opt.selected;
          });
          updateTrackdaysVisibilityProperty();
          updateTrackIcons(true);
          updateTrackPopup();
          updateCalendar();
        });

        for (const [buttonElement, vehicleType] of [[showCarEventsButton, "C"], [showMotoEventsButton, "M"], [showSumoEventsButton, "S"]]) {
          (localStorage.getItem(vehicleType) === "false") ? buttonElement.classList.remove("on") : buttonElement.classList.add("on");
          if (buttonElement.classList.contains("on")) {
            selectedVehicleTypes.add(vehicleType);
          }

          buttonElement.addEventListener("click", () => {
            let nowEnabled = !selectedVehicleTypes.has(vehicleType);
            if (nowEnabled) {
              selectedVehicleTypes.add(vehicleType);
              buttonElement.classList.add("on");
            } else {
              selectedVehicleTypes.delete(vehicleType);
              buttonElement.classList.remove("on");
            }
            localStorage.setItem(vehicleType, nowEnabled);
            if (selectedVehicleTypes.size > 0) {
              homeMarker.setIcon(selectedVehicleTypes.has("C") ? homeIconCar : homeIconMoto);
            }
            updateTrackdaysVisibilityProperty();
            updateTrackIcons(true);
            updateTrackPopup();
            updateCalendar();
            updateDropdown();
          });
        }
        if (selectedVehicleTypes.size === 0 || selectedVehicleTypes.has("C")) {
          homeMarker.setIcon(homeIconCar);
        }

        [priceSliderElement, minDateElement, maxDateElement, daySelectElement].forEach(elem => 
          elem.addEventListener("change", () => {
            updateTrackdaysVisibilityProperty();
            updateTrackIcons(true);
            updateTrackPopup();
            updateCalendar();
          })
        );

        showTracksWithoutEventsToggleElement.addEventListener("click", () => {
          let nowEnabled = !showTracksWithoutEventsToggleElement.classList.contains("on");
          if (nowEnabled) {
            showTracksWithoutEventsToggleElement.classList.add("on");
            showTracksWithoutEventsToggleElement.innerText = showTracksWithoutEventsToggleElement.innerText.replace("Hide", "Show");
          } else {
            showTracksWithoutEventsToggleElement.classList.remove("on");
            showTracksWithoutEventsToggleElement.innerText = showTracksWithoutEventsToggleElement.innerText.replace("Show", "Hide");
          }
          updateTrackIcons(true);
        });

        for (const [buttonElement, eventType] of [[showTrackdaysToggleElement, "T"], [showSchoolsToggleElement, "S"], [showRacesToggleElement, "R"]]) {
          if (buttonElement.classList.contains("on")) {
            selectedEventTypes.add(eventType);
          }
          buttonElement.addEventListener("click", () => {
            let nowEnabled = !buttonElement.classList.contains("on");
            if (nowEnabled) {
              selectedEventTypes.add(eventType);
              buttonElement.classList.add("on");
              buttonElement.innerText = buttonElement.innerText.replace("Hide", "Show");
            } else {
              selectedEventTypes.delete(eventType);
              buttonElement.classList.remove("on");
              buttonElement.innerText = buttonElement.innerText.replace("Show", "Hide");
            }
            updateTrackdaysVisibilityProperty();
            updateTrackIcons(true);
            updateTrackPopup();
            updateCalendar();
            updateDropdown();
          });
        }

        resetElement.addEventListener("click", () => {
          showMotoEventsButton.classList.add("on");
          showSumoEventsButton.classList.add("on");
          showCarEventsButton.classList.add("on");
          selectedVehicleTypes = new Set("MSC");
          localStorage.setItem("M", true);
          localStorage.setItem("S", true);
          localStorage.setItem("C", true);
          showTrackdaysToggleElement.classList.add("on");
          showSchoolsToggleElement.classList.add("on");
          showRacesToggleElement.classList.add("on");
          selectedEventTypes = new Set("TSR");
          Object.values(orgs).forEach(org => org.dropdownSelected = (org.numEvents > 0));
          showTracksWithoutEventsToggleElement.classList.add("on");
          Object.keys(tracks).forEach((track) => {mapMarkers[track].addTo(map);});

          priceSliderElement.value = maxObservedPrice;
          displayedPriceElement.innerText = priceSliderElement.value;
          minDateElement.value = dayjs().format("YYYY-MM-DD");
          maxDateElement.value = "";
          updateMinDateVar();
          updateMaxDateVar();
          Array.from(daySelectElement.options).forEach((opt) => {opt.selected = true;});
          resetHome();
        });

        map.on("mousedown", () => {map.closePopup();});

        resetHome();

      } catch (error) {
        alert("Error: unable to retrieve data");
      }
    };
    visualizeData();
  </script>
</div>

</body>
</html>